variables:
  GIT_DEPTH: 0 # Correction du shallow clone pour SonarQube

stages:
  - test-vault
  - sonar_analysis
  - dependency-update
  - cleanup

test_vault_auth:
  stage: test-vault
  tags:
    - runner
  id_tokens:
    VAULT_ID_TOKEN:
      aud: "https://91.134.72.37:8200"
  before_script:
    - apt-get update -qq
    - apt-get install -y jq
  script:
    - echo "=== JWT Token Claims ==="
    - echo "$VAULT_ID_TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null | jq . || echo "Cannot decode JWT"
    - echo "=== Test connectivit√© Vault ==="
    - curl -k -s "$VAULT_ADDR/v1/sys/health" || echo "Vault non accessible"
    - echo "=== Authentification Vault via JWT ==="
    - |
      VAULT_RESPONSE=$(curl -s -k -X POST \
        -H "Content-Type: application/json" \
        -d "{\"role\":\"$VAULT_ATUH_ROLE_PIPELINE\",\"jwt\":\"$VAULT_ID_TOKEN\"}" \
        "$VAULT_ADDR/v1/auth/jwt/login")
      
      VAULT_TOKEN=$(echo "$VAULT_RESPONSE" | jq -r '.auth.client_token')

      if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
        echo " Echec de l'authentification Vault"
        exit 1
      fi

      export VAULT_TOKEN
      echo "Authentification r√©ussie, token Vault obtenu."
    - echo "=== Lecture du secret SonarQube depuis Vault ==="
    - |
      SECRET_REPONSE=$(curl -s -k \
        -H "X-Vault-Token: $VAULT_TOKEN" \
        "$VAULT_ADDR/v1/sonarqube/data/sonarqube")
      
      SONAR_TOKEN=$(echo "$SECRET_RESPONSE" | jq -r '.data.data.SONAR_TOKEN')
      SONAR_HOST_URL=$(echo "$SECRET_RESPONSE" | jq -r '.datat.data.SONAR_HOST_URL')

      if [ -z "$SONAR_TOKEN" ] || [ "SONAR_TOKEN" = "null" ] || [ -z "$SONAR_HOST_URL" ] || [ "$SONAR_HOST_URL" = "null" ]; then
        echo "Erreur : √©chec lors de la r√©cup√©ration du token SonarQube ou de l'URL."
        exit 1
      fi

      echo "Token SonarQube r√©cup√©r√©e."
      echo "URL SonarQube r√©cup√©r√©e."

      echo "SONAR_TOKEN=$SONAR_TOKEN" >> sonar_secrets.env
      echo "SONAR_HOST_URL=$SONAR_HOST_URL" >> sonar_secrets.env
      openssl enc -aes-256-cbc -salt -in sonar_secrets.env -out sonar_secrets.env.enc -pass pass:"$ENCRYPTION_KEY"
  artifacts:
    paths:
      - sonar_secrets.env

sonar_scan:
  stage: sonar_analysis
  tags:
    - runner-python3
  dependencies:
    - test_vault_auth
  before_script:
    - echo "=== Configuration pip vers Nexus ==="
    - mkdir -p ~/.pip
    - |
      cat > ~/.pip/pip.conf <<EOF
      [global]
      index-url = "https://91.134.72.37:3443/repository/python-group/simple"
      trusted-host = 91.134.72.37
      EOF
    - echo "pip cofigur√© pour utiliser Nexus"
    - python3 -m venv venv
    - source venv/bin/activate
    - echo "=== Installation de coverage depuis Nexus ==="
    - pip install --no-cache-dir coverage unittest-xml-reporting
  script:
   - openssl enc -aes-256-cbc -d -in sonar_secrets.env.enc -out sonar_secrets.env -pass pass:"$ENCRYPTION_KEY"
   - source sonar_secrets.env
   - srouce venv/bin/activate
   - python -m coverage run -m unittest discover -s tests -p 'test_*.py'
   - python -m coverage xml -o coverage.xml
   - python -m coverage report
   - sonar-scanner -Dsonar.host.url="$SONAR_HOST_URL"
      -Dsonar.login="$SONAR_TOKEN"
      -Dsonar.python.coverage.reportPaths=coverage.xml
      -Dsonar.exclusions='**/site-packages/**,**/dist-packages/**,**/__pycache__/**,**/*.pyc'
      -Dsonar.inclusions='src/**/*.py,test/**/*.py'
  only:
    - main

dependabot:
  stage: dependency-update
  image: 
    name: ghcr.io/dependabot/dependabot-updater-pip:latest
    entrypoint: [""] 
  tags:
    - runner
  variables:
    NEXUS_URL: "https://91.134.72.37:3443"
    NEXUS_PYPI_INDEX: "https://91.134.72.37:3443/repository/python-group/simple"
    GITLAB_API: "https://91.134.100.150/api/v4"
    GIT_USER_NAME: "dependabot-bot"
    GIT_USER_EMAIL: "dependabot@example.com"
    BRANCH_NAME: "dependabot-updates"
    DEPENDABOT_PACKAGE_MANAGER: "pip"
    # üî• PRIORIT√â NUCL√âAIRE NEXUS - Blocage total de PyPI public
    PIP_INDEX_URL: "https://91.134.72.37:3443/repository/python-group/simple"
    PIP_TRUSTED_HOST: "91.134.72.37"
    PIP_NO_INDEX: "false"
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
  before_script:
    - echo "‚öôÔ∏è Configuration de l'environnement Dependabot"
    - apt-get update -qq && apt-get install -y git curl jq
    
    # üî• BLOCAGE TOTAL DE PYPI.ORG - PRIORIT√â NUCL√âAIRE NEXUS
    - echo "üö® ACTIVATION DU MODE NEXUS PRIORIT√â ABSOLUE üö®"
    - |
      # Suppression de toute r√©f√©rence √† PyPI public
      mkdir -p ~/.pip
      cat > ~/.pip/pip.conf <<EOF
      [global]
      index-url = https://91.134.72.37:3443/repository/python-group/simple
      trusted-host = 91.134.72.37
      no-cache-dir = true
      disable-pip-version-check = true
      
      [install]
      trusted-host = 91.134.72.37
      EOF
      
      # Configuration pip via variables d'environnement (triple s√©curit√©)
      export PIP_INDEX_URL="https://91.134.72.37:3443/repository/python-group/simple"
      export PIP_TRUSTED_HOST="91.134.72.37"
      export PYTHON_KEYRING_BACKEND=keyring.backends.null.Keyring
      
      # üîí Configuration SSL pour certificat auto-sign√©
      export CURL_CA_BUNDLE=""
      export REQUESTS_CA_BUNDLE=""
      export SSL_CERT_FILE=""
      pip config set global.cert ""
      
      # V√©rification de la config pip
      echo "‚úÖ Configuration pip.conf cr√©√©e:"
      cat ~/.pip/pip.conf
      echo ""
      
    - git config --global user.name "$GIT_USER_NAME"
    - git config --global user.email "$GIT_USER_EMAIL"
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    
  script:
    - echo "üöÄ Analyse des d√©pendances Python avec Dependabot (MODE NEXUS ONLY)"
    
    # üåê TEST DE CONNECTIVIT√â NEXUS (BLOQUANT) - Certificat auto-sign√© OK
    - |
      echo "üåê V√©rification CRITIQUE de la connectivit√© √† Nexus (certificat auto-sign√© accept√©)..."
      
      # Test de plusieurs URLs possibles pour Nexus PyPI
      NEXUS_URLS=(
        "https://91.134.72.37:3443/repository/python-group/simple"
        "https://91.134.72.37:3443/repository/python-group/simple/"
        "https://91.134.72.37:3443/repository/python-group"
        "https://91.134.72.37:3443/repository/python-group/"
      )
      
      WORKING_URL=""
      for url in "${NEXUS_URLS[@]}"; do
        echo "üîç Test de: $url"
        HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" --max-time 5 "$url")
        echo "   ‚Üí HTTP $HTTP_CODE"
        
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
          WORKING_URL="$url"
          echo "   ‚úÖ Cette URL fonctionne !"
          break
        fi
      done
      
      if [ -z "$WORKING_URL" ]; then
        echo ""
        echo "‚ùå ‚ùå ‚ùå ERREUR CRITIQUE: Aucune URL Nexus valide trouv√©e"
        echo ""
        echo "üîç URLs test√©es:"
        for url in "${NEXUS_URLS[@]}"; do
          echo "  - $url"
        done
        echo ""
        echo "üí° Solutions possibles:"
        echo "  1. V√©rifiez dans Nexus UI ‚Üí Repositories ‚Üí python-group ‚Üí Copy URL"
        echo "  2. L'URL correcte devrait ressembler √†:"
        echo "     https://91.134.72.37:3443/repository/python-group/simple"
        echo "  3. Ou sans /simple:"
        echo "     https://91.134.72.37:3443/repository/python-group"
        echo ""
        echo "üîç Test manuel d√©taill√© de l'URL principale:"
        curl -k -v "https://91.134.72.37:3443/repository/python-group/simple" 2>&1 | head -n 40
        exit 1
      fi
      
      echo ""
      echo "‚úÖ ‚úÖ ‚úÖ Nexus est accessible via: $WORKING_URL"
      echo "üîí Certificat auto-sign√© accept√© avec -k/--insecure"
      
      # Mise √† jour de la variable pour utiliser l'URL qui fonctionne
      export NEXUS_PYPI_INDEX="$WORKING_URL"
      export PIP_INDEX_URL="$WORKING_URL"
      pip config set global.index-url "$WORKING_URL"
      
      echo "üîß Configuration mise √† jour avec l'URL fonctionnelle"
    
    # üì¶ INSTALLATION DE pip-tools DEPUIS NEXUS UNIQUEMENT
    - |
      echo "üì• Installation de pip-tools EXCLUSIVEMENT depuis Nexus (certificat auto-sign√© accept√©)..."
      echo "üîó Source: $NEXUS_PYPI_INDEX"
      
      # Installation avec d√©sactivation de la v√©rification SSL
      pip install \
        --index-url "$NEXUS_PYPI_INDEX" \
        --trusted-host "91.134.72.37" \
        --no-cache-dir \
        --disable-pip-version-check \
        pip-tools -v 2>&1 || {
        echo "‚ùå ERREUR: Impossible d'installer pip-tools depuis Nexus"
        echo "üîç Diagnostic:"
        echo "  - URL utilis√©e: $NEXUS_PYPI_INDEX"
        echo "  - Test curl direct du package pip-tools:"
        curl -k -s "$NEXUS_PYPI_INDEX/pip-tools/" 2>&1 | head -n 20 || echo "Package pip-tools introuvable sur Nexus"
        echo ""
        echo "üí° V√©rifiez que pip-tools est bien disponible sur votre Nexus PyPI proxy/group"
        exit 1
      }
      
      echo "‚úÖ pip-tools install√© avec succ√®s depuis Nexus"
    
    # üîç D√âTECTION OU CR√âATION DE requirements.txt
    - |
      echo "üîç Recherche ou cr√©ation de requirements.txt..."
      
      if [ -f "requirements.txt" ]; then
        echo "‚úÖ requirements.txt existe d√©j√†"
        DEPS_FILE="requirements.txt"
      else
        echo "‚ö†Ô∏è requirements.txt n'existe pas - CR√âATION AUTOMATIQUE"
        
        # Recherche de tous les fichiers Python
        PYTHON_FILES=$(find . -name "*.py" -not -path "*/\.*" -not -path "*/venv/*" -not -path "*/env/*")
        
        if [ -z "$PYTHON_FILES" ]; then
          echo "‚ùå Aucun fichier Python trouv√© dans le projet"
          echo "üìù Structure du projet:"
          ls -la
          exit 0
        fi
        
        echo "üêç Fichiers Python trouv√©s:"
        echo "$PYTHON_FILES"
        echo ""
        
        # Extraction des imports Python
        echo "üìã Extraction des d√©pendances depuis le code Python..."
        IMPORTS=$(grep -rh "^import \|^from " --include="*.py" . 2>/dev/null | \
                  sed 's/^import //; s/^from //; s/ import.*//; s/\..*//; s/ as.*//' | \
                  sort -u | \
                  grep -v "^__" | \
                  grep -v "^\." | \
                  tr '[:upper:]' '[:lower:]')
        
        if [ -z "$IMPORTS" ]; then
          echo "‚ö†Ô∏è Aucun import d√©tect√© - Cr√©ation d'un requirements.txt minimal"
          echo "# Fichier g√©n√©r√© automatiquement par Dependabot" > requirements.txt
          echo "# Ajoutez vos d√©pendances ici" >> requirements.txt
        else
          echo "üì¶ Imports d√©tect√©s:"
          echo "$IMPORTS"
          echo ""
          
          # Cr√©ation du requirements.txt avec les packages d√©tect√©s
          echo "# Fichier g√©n√©r√© automatiquement par Dependabot" > requirements.txt
          echo "# Source: Nexus PyPI ($NEXUS_PYPI_INDEX)" >> requirements.txt
          echo "# Date: $(date)" >> requirements.txt
          echo "" >> requirements.txt
          
          # Filtrage des packages standards Python (pas besoin de les installer)
          STDLIB="os sys re json time datetime collections math random string io argparse logging"
          
          for pkg in $IMPORTS; do
            # V√©rifier si ce n'est pas un package standard
            if ! echo "$STDLIB" | grep -qw "$pkg"; then
              # Tentative de r√©solution du package sur Nexus
              echo "üîç Recherche de $pkg sur Nexus..."
              if curl -k -s --max-time 5 "$NEXUS_PYPI_INDEX/$pkg/" 2>/dev/null | grep -qi "$pkg\|<html"; then
                echo "$pkg" >> requirements.txt
                echo "  ‚úÖ $pkg trouv√© sur Nexus"
              else
                echo "  ‚ö†Ô∏è $pkg non trouv√© sur Nexus (ignor√©)"
              fi
            fi
          done
          
          echo ""
          echo "üìÑ requirements.txt g√©n√©r√©:"
          cat requirements.txt
        fi
        
        DEPS_FILE="requirements.txt"
        
        # Commit du fichier nouvellement cr√©√©
        if [ -f "requirements.txt" ] && [ -s "requirements.txt" ]; then
          git add requirements.txt
          if ! git diff --cached --quiet; then
            echo "üíæ Commit du nouveau requirements.txt..."
            git checkout -B "$BRANCH_NAME"
            git commit -m "chore: cr√©ation automatique de requirements.txt

            Fichier g√©n√©r√© automatiquement par Dependabot
            Source: Nexus PyPI ($NEXUS_PYPI_INDEX)
            
            D√©pendances d√©tect√©es depuis le code Python du projet."
            
            git push -f "https://oauth2:${GITLAB_TOKEN}@91.134.100.150/${CI_PROJECT_PATH}.git" "$BRANCH_NAME"
            
            echo "üîÄ Cr√©ation de la Merge Request pour le nouveau requirements.txt..."
            MR_RESPONSE=$(curl -k -s --request POST "${GITLAB_API}/projects/${CI_PROJECT_ID}/merge_requests" \
              --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              --header "Content-Type: application/json" \
              --data "{
                \"source_branch\": \"${BRANCH_NAME}\",
                \"target_branch\": \"main\",
                \"title\": \"üì¶ Cr√©ation automatique de requirements.txt\",
                \"description\": \"Ce fichier requirements.txt a √©t√© g√©n√©r√© automatiquement par Dependabot en analysant les imports Python du projet.\\n\\n### Source\\n- Nexus PyPI: $NEXUS_PYPI_INDEX\\n\\n**Action requise:** V√©rifiez et mergez ce fichier pour activer les mises √† jour automatiques.\",
                \"remove_source_branch\": true,
                \"squash\": true
              }")
            
            echo "$MR_RESPONSE" | jq -r '.web_url // "‚ùå Erreur lors de la cr√©ation de la MR"'
            
            echo "‚úÖ Merge Request cr√©√©e - Prochain run analysera les mises √† jour"
            exit 0
          fi
        fi
      fi
    
    # üîÑ ANALYSE ET MISE √Ä JOUR DES D√âPENDANCES (MODE NEXUS ONLY)
    - |
      echo "üì¶ Analyse de $DEPS_FILE avec NEXUS UNIQUEMENT"
      echo "üìÑ Contenu actuel de $DEPS_FILE:"
      cat "$DEPS_FILE"
      echo ""
      
      # Sauvegarde
      cp "$DEPS_FILE" "${DEPS_FILE}.old"
      
      # Cr√©ation du requirements.in si n√©cessaire
      if [ ! -f "requirements.in" ]; then
        cp "$DEPS_FILE" requirements.in
        echo "üìù requirements.in cr√©√© depuis requirements.txt"
      fi
      
      echo "üîÑ Compilation avec pip-compile (SOURCE: NEXUS UNIQUEMENT)"
      echo "üîó Index: $NEXUS_PYPI_INDEX"
      
      # Compilation avec TOUS les flags Nexus + certificat auto-sign√© OK
      pip-compile \
        --index-url "$NEXUS_PYPI_INDEX" \
        --trusted-host "91.134.72.37" \
        --upgrade \
        --verbose \
        --no-header \
        --allow-unsafe \
        --output-file "${DEPS_FILE}.new" \
        requirements.in 2>&1 || \
      pip-compile \
        --index-url "$NEXUS_PYPI_INDEX" \
        --trusted-host "91.134.72.37" \
        --upgrade \
        --verbose \
        --allow-unsafe \
        --output-file "${DEPS_FILE}.new" \
        "$DEPS_FILE" 2>&1 || {
          echo "‚ö†Ô∏è Erreur lors de la compilation"
          echo "üìã V√©rifiez que tous les packages sont disponibles sur Nexus"
          echo "üîç Packages demand√©s:"
          cat requirements.in 2>/dev/null || cat "$DEPS_FILE"
          exit 0
      }
      
      # V√©rification des changements
      if [ -f "${DEPS_FILE}.new" ]; then
        echo ""
        echo "üìÑ Nouveau contenu g√©n√©r√© depuis NEXUS:"
        cat "${DEPS_FILE}.new"
        echo ""
        
        if ! diff -q "$DEPS_FILE" "${DEPS_FILE}.old" > /dev/null 2>&1; then
          echo "üìù ‚úÖ MISES √Ä JOUR D√âTECT√âES depuis Nexus !"
          echo "üìä Diff√©rences:"
          diff "$DEPS_FILE" "${DEPS_FILE}.new" || true
          echo ""
          
          mv "${DEPS_FILE}.new" "$DEPS_FILE"
          
          git checkout -B "$BRANCH_NAME"
          git add "$DEPS_FILE"
          
          if [ -f "requirements.in" ]; then
            git add requirements.in
          fi
          
          git commit -m "chore(deps): mise √† jour automatique des d√©pendances Python

          Mises √† jour effectu√©es par Dependabot
          Source EXCLUSIVE: Nexus PyPI
          URL: $NEXUS_PYPI_INDEX
          
          ‚úÖ Toutes les d√©pendances proviennent de Nexus
          ‚úÖ Aucune connexion √† PyPI public
          ‚úÖ Versions compatibles v√©rifi√©es"
          
          echo "‚¨ÜÔ∏è Push de la branche $BRANCH_NAME..."
          git push -f "https://oauth2:${GITLAB_TOKEN}@91.134.100.150/${CI_PROJECT_PATH}.git" "$BRANCH_NAME"
          
          echo "üîÄ Cr√©ation de la Merge Request..."
          MR_RESPONSE=$(curl -k -s --request POST "${GITLAB_API}/projects/${CI_PROJECT_ID}/merge_requests" \
            --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "{
              \"source_branch\": \"${BRANCH_NAME}\",
              \"target_branch\": \"main\",
              \"title\": \"üîÑ Mise √† jour automatique des d√©pendances Python (Nexus)\",
              \"description\": \"Cette MR contient les mises √† jour automatiques des d√©pendances Python.\\n\\n### ‚úÖ Source EXCLUSIVE\\n- Nexus PyPI: \`$NEXUS_PYPI_INDEX\`\\n- ‚ùå Aucune connexion √† PyPI public\\n\\n### Changements\\n\\\`\\\`\\\`diff\\n$(diff ${DEPS_FILE}.old $DEPS_FILE | head -n 20)\\n\\\`\\\`\\\`\\n\\n**Note:** V√©rifiez les tests avant de merger.\",
              \"remove_source_branch\": true,
              \"squash\": true
            }")
          
          echo "$MR_RESPONSE" | jq -r '.web_url // "‚ùå Erreur lors de la cr√©ation de la MR"'
        else
          echo "‚úÖ Aucune mise √† jour disponible - $DEPS_FILE est d√©j√† √† jour avec les versions Nexus"
          rm -f "${DEPS_FILE}.new"
        fi
      else
        echo "‚ö†Ô∏è Fichier .new non g√©n√©r√© - v√©rifiez les logs ci-dessus"
      fi
     
  rules:
    - when: always
  allow_failure: true

reset_runners:
  stage: cleanup
  tags:
    - runner-clean
  before_script:
    - apt update && apt install jq curl bash
  script:
    - chmod +x ./scripts/reset-runner.sh
    - ./scripts/reset-runner.sh
  when: always
  allow_failure: true
  only:
    - main